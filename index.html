<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartHub AI v1.0.6</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #0b0f19;
      --text-dark: #eef;
      --bg-light: #f3f3f3;
      --text-light: #111;
      --panel-dark: rgba(255,255,255,0.04);
      --panel-light: rgba(0,0,0,0.04);
      --accent: #00d4ff;
      --font: 'Inter', system-ui, Arial, sans-serif;
    }
    body {
      margin: 0;
      font-family: var(--font);
      background: var(--bg-dark);
      color: var(--text-dark);
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }
    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    .app {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      padding: 20px;
      height: 100vh;
      box-sizing: border-box;
    }

    .panel {
      background: var(--panel-dark);
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    body.light .panel {
      background: var(--panel-light);
    }

    .header {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }

    .chat-window {
      flex: 1;
      background: var(--panel-dark);
      border-radius: 10px;
      padding: 12px;
      overflow-y: auto;
      min-height: 120px;
    }
    body.light .chat-window {
      background: var(--panel-light);
    }

    .msg {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .bubble {
      padding: 12px 14px;
      border-radius: 12px;
      max-width: 78%;
      line-height: 1.35;
      background: var(--panel-dark);
      position: relative;
      overflow: hidden;
    }
    .msg.user .bubble {
      background: var(--accent);
      color: #002;
      margin-left: auto;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏ */
    .bubble.typing::after {
      content: '';
      display: inline-block;
      width: 4px;
      height: 1em;
      background: var(--accent);
      margin-left: 4px;
      animation: blink 1s infinite;
      vertical-align: bottom;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .bubble.text-reveal {
      animation: revealText 0.5s ease-out forwards;
    }
    @keyframes revealText {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-row input[type="text"] {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: rgba(0,0,0,0.2);
      color: inherit;
      outline: none;
    }
    .icon-btn, .small-btn {
      cursor: pointer;
      border: none;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .icon-btn {
      width: 48px;
      height: 48px;
      background: var(--accent);
      color: #002;
      font-weight: bold;
    }
    .small-btn {
      width: 44px;
      height: 44px;
      background: #222;
      color: #ddd;
    }

    .settings {
      background: var(--panel-dark);
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    body.light .settings {
      background: var(--panel-light);
    }
    .settings h3 { color: var(--accent); margin: 0; font-size: 20px; }
    .field { display: flex; flex-direction: column; gap: 8px; font-size: 14px; }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      opacity: .85;
    }
    .version { margin-left: auto; }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="header">SmartHub AI</div>
      <div id="chat" class="chat-window" role="log" aria-live="polite"></div>
      <div class="input-row">
        <input id="userInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
        <button class="icon-btn" id="sendBtn">‚û§</button>
        <button class="small-btn" id="micBtn">üé§</button>
        <button class="small-btn" id="speakBtn">üîä</button>
      </div>
      <div class="footer">
        <div class="version">SmartHub AI v1.0.6</div>
      </div>
    </div>

    <aside class="settings" id="settingsPanel">
      <h3>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="field">
        <label><input type="checkbox" id="themeSwitch"> –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</label>
      </div>
      <div class="field">
        <label>–û–∑–≤—É—á–∫–∞:</label>
        <select id="voiceSelect">
          <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          <option value="male">–ú—É–∂—Å–∫–æ–π</option>
        </select>
      </div>
      <button id="clearBtn" style="padding:12px;background:#ff7b00;color:#001;border:none;border-radius:10px;cursor:pointer;">
        üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
      </button>
    </aside>
  </div>

  <script>
    const API_URL = "https://openai-proxy-3.onrender.com/v1/responses";

    let chatHistory = JSON.parse(localStorage.getItem('sh_chatHistory') || '[]');
    let lastAI = "";
    let voicesList = [];
    const savedVoice = localStorage.getItem('sh_voice_gender') || 'female';

    const chatEl = document.getElementById('chat');
    const themeSwitch = document.getElementById('themeSwitch');
    const voiceSelect = document.getElementById('voiceSelect');

    function renderMessage(text, role) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + role;
      const bubble = document.createElement('div');
      bubble.className = 'bubble typing';
      wrap.append(bubble);
      chatEl.append(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;

      // –ø–µ—á–∞—Ç—å —Ç–µ–∫—Å—Ç–∞ –ø–æ –±—É–∫–≤–∞–º
      let i = 0;
      const interval = setInterval(() => {
        bubble.textContent += text.charAt(i);
        i++;
        if (i >= text.length) {
          clearInterval(interval);
          bubble.classList.remove('typing');
          bubble.classList.add('text-reveal');
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }, 30);
    }

    function saveHistory() {
      localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
    }

    function clearChat() {
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?')) return;
      chatHistory = [];
      localStorage.removeItem('sh_chatHistory');
      chatEl.innerHTML = '';
      lastAI = '';
    }

    function speakText(text) {
      if (!text) return;
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ru-RU'; // –∑–∞–¥–∞—ë–º —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –æ–∑–≤—É—á–∫–∏

      let voice = voicesList.find(v => {
        if (voiceSelect.value === 'male') {
          return /male|man/i.test(v.name);
        } else {
          return /female|woman/i.test(v.name);
        }
      });
      if (!voice && voicesList.length) {
        // –∫–∞–∫ fallback ‚Äî –≥–æ–ª–æ—Å –ª—é–±–æ–≥–æ —è–∑—ã–∫–∞
        voice = voicesList[0];
      }
      if (voice) utter.voice = voice;

      localStorage.setItem('sh_voice_gender', voiceSelect.value);
      synth.cancel();
      synth.speak(utter);
    }

    function startSpeechToText() {
      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Rec) {
        alert("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        return;
      }
      const rec = new Rec();
      rec.lang = "ru-RU";
      rec.onresult = (e) => {
        const text = e.results[0][0].transcript;
        document.getElementById('userInput').value = text;
      };
      rec.start();
    }

    async function sendMessage(text) {
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ‚Äú...‚Äù –∫–∞–∫ –ø–µ—á–∞—Ç–∞—é—â–µ–µ
      renderMessage("...", "ai");
      try {
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: "gpt-4o-mini", messages: [{ role: "user", content: text }] })
        });
        const data = await resp.json();
        let answer = "";
        if (data.choices && data.choices[0]?.message?.content) {
          answer = data.choices[0].message.content;
        } else {
          answer = "–û—à–∏–±–∫–∞: –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞";
        }
        lastAI = answer;
        chatHistory.push({ role: "ai", text: answer });
        saveHistory();

        // —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é ¬´typing¬ª —Ñ—Ä–∞–∑—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –Ω–∞—Å—Ç–æ—è—â–∏–π –æ—Ç–≤–µ—Ç
        chatEl.removeChild(chatEl.lastChild);
        renderMessage(answer, "ai");
      } catch (e) {
        console.error(e);
        chatEl.removeChild(chatEl.lastChild);
        renderMessage("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", "ai");
      }
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
      const inp = document.getElementById('userInput');
      const txt = inp.value.trim();
      if (!txt) return;
      chatHistory.push({ role: "user", text: txt });
      saveHistory();
      renderMessage(txt, "user");
      inp.value = "";
      sendMessage(txt);
    });
    document.getElementById('micBtn').addEventListener('click', startSpeechToText);
    document.getElementById('speakBtn').addEventListener('click', () => speakText(lastAI));
    document.getElementById('clearBtn').addEventListener('click', clearChat);

    themeSwitch.addEventListener('change', () => {
      document.body.classList.toggle('light', themeSwitch.checked);
      localStorage.setItem('sh_theme_is_light', themeSwitch.checked ? '1' : '0');
    });

    voiceSelect.value = savedVoice;

    (function init() {
      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
      chatHistory.forEach(m => renderMessage(m.text, m.role));

      // —Ç–µ–º—ã
      const light = localStorage.getItem('sh_theme_is_light') === '1';
      themeSwitch.checked = light;
      document.body.classList.toggle('light', light);

      // –≥–æ–ª–æ—Å–∞
      voicesList = window.speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        voicesList = window.speechSynthesis.getVoices();
      };
    })();
  </script>
</body>
</html>
