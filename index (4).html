<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SmartHub AI v1.0.5</title>
<style>
/* ---------- –±–∞–∑–æ–≤–∞—è —Ç–µ–º–∞ ---------- */
:root{
  --bg:#0b0f19; --panel:rgba(255,255,255,0.04); --accent:#00d4ff; --muted:rgba(255,255,255,0.6);
  --input:#0e1218; --bubble-user:#00d4ff; --bubble-ai:rgba(0,255,170,0.18); --danger:#ff3b3b;
}
body{margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:var(--bg);color:#eef;min-height:100vh;}

/* layout */
.app{
  display:grid;
  grid-template-columns: 1fr 360px;
  gap:18px;
  padding:20px;
  box-sizing:border-box;
  height:100vh;
  align-items:stretch;
}

/* CHAT PANEL */
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
  border-radius:14px;
  padding:18px;
  display:flex;flex-direction:column; gap:12px;
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
}
.header{
  text-align:center; font-weight:700; font-size:20px; color:var(--accent); text-shadow:0 6px 18px rgba(0,212,255,0.06);
}

/* chat area */
.chat-window{
  background:var(--panel);
  border-radius:10px;
  padding:12px;
  flex:1;
  overflow:auto;
  min-height:120px;
}
.msg{
  display:flex; gap:12px; align-items:flex-start; margin-bottom:12px;
  opacity:1; transition:all .18s ease;
}
.msg .avatar{
  width:54px;height:54px;border-radius:50%;flex:0 0 54px;overflow:hidden;display:flex;align-items:center;justify-content:center;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}
.bubble{
  padding:12px 14px;border-radius:12px;max-width:78%;line-height:1.35;
  background:rgba(255,255,255,0.04);
}

/* user vs ai */
.msg.user{justify-content:flex-end; flex-direction:row-reverse;}
.msg.user .bubble{background:var(--bubble-user); color:#002;}
.msg.user .avatar{box-shadow:none;}
.msg.ai .bubble{background:var(--bubble-ai); color:#e9fff0;}

/* input row */
.input-row{display:flex; gap:10px; align-items:center}
.input-row input{
  flex:1; padding:12px 14px; border-radius:12px; border:none; background:var(--input); color:inherit;
  outline:none; box-shadow:inset 0 -2px 0 rgba(0,0,0,0.5);
}
.icon-btn{
  width:48px;height:48px;border-radius:10px;border:none;background:var(--accent);cursor:pointer;color:#002;font-weight:700;
  display:inline-flex;align-items:center;justify-content:center;
}
.small-btn{width:44px;height:44px;border-radius:10px;border:none;background:#222;color:#ddd;display:inline-flex;align-items:center;justify-content:center;}

/* settings panel */
.settings{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
  border-radius:14px;padding:18px; display:flex;flex-direction:column; gap:12px;
}
.settings h3{margin:0 0 6px 0; color:var(--accent);}
.field{display:flex;flex-direction:column;gap:8px;font-size:14px;margin-bottom:6px;}
.select, .switch, select{padding:8px;border-radius:8px;border:none;background:#0e1218;color:inherit;}
.avatar-select{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.avatar-preview{width:72px;height:72px;border-radius:50%;border:3px solid var(--accent);display:block;object-fit:cover;}
.avatar-option{width:52px;height:52px;border-radius:50%;cursor:pointer;border:2px solid transparent;opacity:.85;transition:all .12s ease}
.avatar-option:hover{transform:scale(1.06);border-color:var(--accent);opacity:1}

/* controls bottom */
.footer{display:flex;justify-content:space-between;align-items:center;padding-top:6px;font-size:13px;opacity:.85}
.version{margin-left:auto;}

/* utility */
.hidden{display:none}
.small-muted{font-size:13px;color:var(--muted);opacity:.9}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:8px 0;border-radius:2px}

/* responsive */
@media(max-width:980px){
  .app{grid-template-columns:1fr; padding:12px;}
  .settings{order:-1}
}
</style>
</head>
<body>
<div class="app">

  <!-- CHAT -->
  <div class="panel">
    <div class="header">SmartHub AI</div>

    <div id="chat" class="chat-window" aria-live="polite" role="log"></div>

    <div class="input-row">
      <input id="userInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
      <button class="icon-btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
      <button class="small-btn" id="micBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
      <button class="small-btn" id="speakBtn" title="–û–∑–≤—É—á–∏—Ç—å">üîä</button>
    </div>

    <div class="footer">
      <div class="small-muted">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
      <div class="version">SmartHub AI v1.0.4</div>
    </div>
  </div>

  <!-- SETTINGS -->
  <aside class="settings" id="settingsPanel">
    <h3>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

    <div class="field">
      <label class="small-muted">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
      <label style="display:flex;align-items:center;gap:12px">
        <input type="checkbox" id="themeSwitch" />
        <span class="small-muted">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
      </label>
    </div>

    <div class="field">
      <label class="small-muted">–û–∑–≤—É—á–∫–∞</label>
      <select id="voiceSelect" class="select">
        <option value="female">–ñ–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å</option>
        <option value="male">–ú—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å</option>
      </select>
    </div>

    <div class="field">
      <label class="small-muted">–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
      <img id="avatarPreview" class="avatar-preview" alt="avatar preview" />
      <div class="avatar-select" id="avatarOptions"></div>
    </div>

    <div class="hr"></div>

    <button id="clearBtn" style="padding:12px;background:#ff7b00;border:none;border-radius:10px;color:#001;font-weight:700;cursor:pointer">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    <div class="small-muted" style="margin-top:10px">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
  </aside>

</div>

<script>
/* ================= CONFIG - change API URL to your working proxy ================= */
const API_URL = "https://openai-proxy-3.onrender.com/v1/responses";
/* ================================================================================= */

/* ----- state ----- */
let userAvatar = localStorage.getItem('sh_userAvatar') || 'svg:user:1';
let chatHistory = JSON.parse(localStorage.getItem('sh_chatHistory') || '[]');
let lastAI = "";

/* ----- built-in SVG avatars (no external images) ----- */
const AVATARS = {
  'svg:user:1': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g1' x1='0' x2='1'><stop offset='0' stop-color='#00d4ff'/><stop offset='1' stop-color='#00ffa3'/></linearGradient></defs><rect width='120' height='120' rx='24' fill='url(#g1)'/><g fill='#001' opacity='0.14'><circle cx='60' cy='44' r='20'/><rect x='20' y='74' width='80' height='28' rx='12'/></g><circle cx='60' cy='44' r='18' fill='#fff' opacity='0.15'/></svg>`,
  'svg:user:2': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g2' x1='0' x2='1'><stop offset='0' stop-color='#7b61ff'/><stop offset='1' stop-color='#ff61b8'/></linearGradient></defs><rect width='120' height='120' rx='24' fill='url(#g2)'/><g fill='#001' opacity='0.14'><circle cx='60' cy='44' r='20'/></g></svg>`,
  'svg:user:3': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g3' x1='0' x2='1'><stop offset='0' stop-color='#ffb86b'/><stop offset='1' stop-color='#ff6b6b'/></linearGradient></defs><rect width='120' height='120' rx='24' fill='url(#g3)'/></svg>`,
  'svg:ai:1': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><rect width='120' height='120' rx='24' fill='#0de7c9'/><circle cx='36' cy='44' r='18' fill='#fff' opacity='.85'/><circle cx='84' cy='44' r='18' fill='#fff' opacity='.65'/></svg>`
};

/* ----- helper to render SVG avatar inline (data URL) ----- */
function svgToDataUrl(svg){
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* ----- render avatars selection UI ----- */
function buildAvatarOptions(){
  const container = document.getElementById('avatarOptions');
  container.innerHTML = '';
  Object.keys(AVATARS).forEach(key=>{
    if(!key.startsWith('svg:user')) return;
    const img = document.createElement('img');
    img.src = svgToDataUrl(AVATARS[key]);
    img.className = 'avatar-option';
    img.title = key;
    img.addEventListener('click', ()=>{ setUserAvatar(key); });
    container.appendChild(img);
  });
  // preview
  document.getElementById('avatarPreview').src = svgToDataUrl(AVATARS[userAvatar] || AVATARS['svg:user:1']);
}

/* ----- chat rendering & persistence ----- */
const chatEl = document.getElementById('chat');

function renderMessage(item){
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (item.role==='user'?'user':'ai');
  const av = document.createElement('div'); av.className='avatar';
  const img = document.createElement('img'); img.className='avatar-img';
  img.src = item.avatar; img.alt = item.role;
  img.style.width='54px'; img.style.height='54px'; img.style.borderRadius='50%';
  av.appendChild(img);
  const bubble = document.createElement('div'); bubble.className='bubble';
  bubble.textContent = item.text;
  wrap.appendChild(av); wrap.appendChild(bubble);
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function saveAndRenderMessage(text, role){
  const avatarData = role==='user' ? svgToDataUrl(AVATARS[userAvatar]) : svgToDataUrl(AVATARS['svg:ai:1']);
  const item = {text, role, avatar: avatarData, at: Date.now()};
  chatHistory.push(item);
  localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
  renderMessage(item);
}

/* ----- load history on start ----- */
function loadHistory(){
  chatEl.innerHTML=''; 
  chatHistory.forEach(renderMessage);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* ----- clear chat ----- */
function clearChat(){
  if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç?')) return;
  chatHistory = [];
  localStorage.removeItem('sh_chatHistory');
  chatEl.innerHTML = '';
  lastAI = '';
  alert('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
}

/* ----- set user avatar ----- */
function setUserAvatar(key){
  if(!AVATARS[key]) return;
  userAvatar = key;
  localStorage.setItem('sh_userAvatar', userAvatar);
  buildAvatarOptions();
}

/* ----- speak (single button) ----- */
function speakText(text){
  if(!text) return;
  const synth = window.speechSynthesis;
  if(!synth) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ru-RU';
  // pick voice loosely
  const pref = document.getElementById('voiceSelect').value;
  const voices = speechSynthesis.getVoices();
  if(pref==='male'){
    utter.voice = voices.find(v=>/male|man|sergei|alex/i.test(v.name)) || voices[0];
  } else {
    utter.voice = voices.find(v=>/female|woman|zira|salli/i.test(v.name)) || voices[0];
  }
  synth.cancel();
  synth.speak(utter);
}

/* ----- voice input ----- */
function startSpeechToText(){
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!Rec){ alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return; }
  const r = new Rec();
  r.lang='ru-RU';
  r.onresult = e=>{
    const text = e.results[0][0].transcript;
    document.getElementById('userInput').value = text;
  };
  r.onerror = ()=>{ /* ignore */ };
  r.start();
}

/* ----- send message to proxy and handle response ----- */
async function sendToProxy(text){
  // show typing indicator
  saveAndRenderMessage('...', 'ai');
  try{
    const resp = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ model:'gpt-4o-mini', input: text })
    });
    if(!resp.ok){
      // remove last '...' message and replace with error
      chatHistory.pop();
      localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
      saveAndRenderMessage('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + resp.status + ' ' + resp.statusText, 'ai');
      return;
    }
    const data = await resp.json();
    // support both old choices and responses.output
    let answer = null;
    if(data.output && Array.isArray(data.output) && data.output[0] && data.output[0].content){
      // responses format
      const chunks = data.output[0].content;
      // try to get text
      const textChunk = chunks.find(c=>c.type==='output_text') || chunks.find(c=>c.type==='message');
      answer = textChunk ? (textChunk.text || textChunk.parts && textChunk.parts.join('') || textChunk.content) : null;
    }
    if(!answer && data.choices && data.choices[0] && data.choices[0].message){
      answer = data.choices[0].message.content || (data.choices[0].message && data.choices[0].message.content && data.choices[0].message.content.text);
    }
    if(!answer && typeof data === 'string') answer = data;
    if(!answer) answer = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞';
    // replace last '...' ai message
    chatHistory.pop();
    localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
    saveAndRenderMessage(answer, 'ai');
    lastAI = answer;
  }catch(err){
    chatHistory.pop();
    localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
    saveAndRenderMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø—Ä–æ–∫—Å–∏/—Å–µ—Ä–≤–µ—Ä–æ–º', 'ai');
    console.error(err);
  }
}

/* ----- event handlers ----- */
document.getElementById('sendBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('userInput').value.trim();
  if(!txt) return;
  document.getElementById('userInput').value='';
  saveAndRenderMessage(txt,'user');
  sendToProxy(txt);
});

document.getElementById('userInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter') { e.preventDefault(); document.getElementById('sendBtn').click(); }
});

document.getElementById('micBtn').addEventListener('click', startSpeechToText);
document.getElementById('clearBtn').addEventListener('click', clearChat);
document.getElementById('speakBtn').addEventListener('click', ()=>speakText(lastAI));

document.getElementById('themeSwitch').addEventListener('change', (e)=>{
  const on = e.target.checked;
  if(on){ document.body.classList.add('light'); document.body.classList.remove('dark'); }
  else { document.body.classList.remove('light'); document.body.classList.add('dark'); }
  localStorage.setItem('sh_theme_is_light', on? '1' : '0');
});

/* ----- init ----- */
(function init(){
  // avatars UI
  buildAvatarOptions();
  // load theme
  const themeIsLight = localStorage.getItem('sh_theme_is_light') === '1';
  if(themeIsLight){ document.getElementById('themeSwitch').checked = true; document.body.classList.add('light'); document.body.classList.remove('dark'); }
  // load saved avatar
  if(!AVATARS[userAvatar]) { userAvatar = 'svg:user:1'; localStorage.setItem('sh_userAvatar', userAvatar); }
  document.getElementById('avatarPreview').src = svgToDataUrl(AVATARS[userAvatar]);
  // load history
  loadHistory();
  // populate voices (some browsers load voices asynchronously)
  window.speechSynthesis.onvoiceschanged = ()=>{ /* nothing needed, speak picks voices at call time */ };
})();
</script>
</body>
</html>
